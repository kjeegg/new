#include "spi.h"
#include "../lib/atmega2560constants.h"
#include "../lib/lcd.h"
#include "../lib/util.h"
#include "../os_scheduler.h"

#include <avr/interrupt.h>
#include <avr/io.h>
#include <avr/pgmspace.h>
#include <util/delay.h>

// Hardware mappings
#define SPI_PORT         PORTB
#define SPI_DDR          DDRB
#define SPI_PIN          PINB

#define SPI_CS_BIT       PB0
#define SPI_MOSI_BIT     PB2
#define SPI_MISO_BIT     PB3
#define SPI_CLK_BIT      PB1

// Long form of registers
#define SPI_CONTROL_REGISTER      SPCR
#define SPI_ENABLE                SPE
#define SPI_DATA_ORDER            DORD
#define SPI_MASTER_ENABLE         MSTR
#define SPI_CLOCK_POLARITY        CPOL
#define SPI_CLOCK_PHASE           CPHA
#define SPI_CLOCK_RATE_SELECT0    SPR0
#define SPI_CLOCK_RATE_SELECT1    SPR1
#define SPI_DUMMY_BYTE            0xFF

//----------------------------------------------------------------------------
// Already given functions
//----------------------------------------------------------------------------

void spi_cs_enable()
{
    SPI_PORT &= ~(1 << SPI_CS_BIT);
}

void spi_cs_disable()
{
    SPI_PORT |= (1 << SPI_CS_BIT);
}

//----------------------------------------------------------------------------
// Your Homework
//----------------------------------------------------------------------------

/*!
 *  Initializes the SPI interface
 */
void spi_init()
{
    
    // ??????????? ?????? ?? PORTB ??? SPI:
    // CS (PB0), MOSI (PB2), SCK (PB1) — ??? ??????, MISO (PB3) — ????.
    SPI_DDR |= (1 << SPI_CS_BIT)   // CS ??? ?????
            |  (1 << SPI_MOSI_BIT) // MOSI ??? ?????
            |  (1 << SPI_CLK_BIT); // SCK ??? ?????
    SPI_DDR &= ~(1 << SPI_MISO_BIT); // MISO ??? ????

    // ????????? CS ? «??????????» ????????? (???.1)
    spi_cs_disable();

    /*
     * ??????????? ???????? SPI:
     * - SPE=1  : ?????????? SPI
     * - MSTR=1 : ???????? ? ?????? Master
     * - SPR0=1 : ??????? SPI = F_CPU/16 (??? CPOL=0 ? CPHA=0)
     * ????????? ???? ?? ????????? 0, DORD=0 (MSB first), CPOL=0, CPHA=0
     */
    SPI_CONTROL_REGISTER = (1 << SPI_ENABLE) | (1 << SPI_MASTER_ENABLE) | (1 << SPI_CLOCK_RATE_SELECT0);

    // ?????????? ???? ??????????
    // (?????????????, ?? ?????? ?????? ??????? SPSR ? SPDR)
    uint8_t dummy = SPSR;
    dummy = SPDR;
    (void)dummy; // ????? ?????????? ?? ???????
}

/*!
 *  Writes and simultaneously reads a byte over the SPI interface
 *
 *  \param byte The byte that will be sent
 *  \return The byte that has been read
 */
uint8_t spi_write_read(uint8_t byte)
{
    // ?????????? ???? ? ??????? ??????
    SPDR = byte;
    // ????, ???? ???????a ?????????? (SPIF = 1)
    while (!(SPSR & (1 << SPIF)))
    {
        // ????????
    }
    // ?????????? ???????? ????
    return SPDR;
}

/*!
 *  Reads a byte over the SPI interface by writing a dummy byte
 *
 *  \return The byte that has been read
 */
uint8_t spi_read()
{
    // ????? ???-?? ?????????, ???????? «??????» (dummy) ????
    SPDR = SPI_DUMMY_BYTE;
    while (!(SPSR & (1 << SPIF)))
    {
        // ????????
    }
    return SPDR;
}

/*!
 *  Writes a byte over the SPI interface and discards the received byte
 *
 *  \param byte the byte that will be sent
 */
void spi_write(uint8_t byte)
{
    SPDR = byte;
    while (!(SPSR & (1 << SPIF)))
    {
        // ????????
    }
    // ???????? ???? ??? ?? ?????, ?? ????? «??????????» ????, ????? ????????? SPDR
    (void)SPDR;
}

/*!
 *  Writes multiple bytes over the SPI interface
 *
 *  \param data buffer which will be sent through SPI
 *  \param length size of the buffer
 */
void spi_writeData(void *data, uint8_t length)
{
    // ??????????? data ? ????????? ?? uint8_t
    uint8_t *p = (uint8_t *)data;
    for (uint8_t i = 0; i < length; i++)
    {
        spi_write(p[i]);
    }
}

/*!
 *  Writes multiple bytes over the SPI interface from program memory
 *
 *  \param data buffer which will be sent through SPI
 *  \param length size of the buffer
 */
void spi_writeDataProgMem(const void *data, uint8_t length)
{
    // ?????? ?? program memory ? ????? ????? ?? ??????
    for (uint8_t i = 0; i < length; i++)
    {
        // ????????? ???? ?? flash
        uint8_t b = pgm_read_byte(((const uint8_t *)data) + i);
        spi_write(b);
    }
}
